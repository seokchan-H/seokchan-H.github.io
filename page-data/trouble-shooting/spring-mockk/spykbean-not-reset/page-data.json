{"componentChunkName":"component---src-templates-blog-post-js","path":"/trouble-shooting/spring-mockk/spykbean-not-reset/","result":{"data":{"site":{"siteMetadata":{"title":"Dudeys Blog"}},"markdownRemark":{"id":"c146b920-75e2-5672-8c0a-bc23ba94298a","excerpt":"SpringMockk 에서 MockkBean, SpykBean 은 MockkClear 설정에 의해 Mocking 을 Reset 한다.\nSpringMockk 에서 MockkBean, SpykBean 은 MockkClear 의 기본 설정은 MockkClear.AFTER…","html":"<p>SpringMockk 에서 MockkBean, SpykBean 은 MockkClear 설정에 의해 Mocking 을 Reset 한다.\nSpringMockk 에서 MockkBean, SpykBean 은 MockkClear 의 기본 설정은 MockkClear.AFTER 이다.</p>\n<p>문제는 이 기능이 AOP 로 래핑된 객체에 대해서 정상작동 하지 않는다는 것이다.\n예를 들어 <code class=\"language-text\">@Transactional</code>, <code class=\"language-text\">@Repository</code> 가 적용된 객체는 테스트시 verify 가 갱신되지 않아 테스트 검증이 실패될 수 있다.</p>\n<p>해당 이슈는 CGLIB 기반의 프록시 객체에 대해서 발생한다.\n그렇기에 다음과 같이 단순히 객체를 명시적으로 Reset 하면 실패하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">    <span class=\"token annotation builtin\">@SpykBean</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">lateinit</span> <span class=\"token keyword\">var</span> testClass<span class=\"token operator\">:</span> TestClass\n\n    <span class=\"token annotation builtin\">@BeforeEach</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">clearSpykBean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">clearMocks</span><span class=\"token punctuation\">(</span>testClass<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3d9c4b46dea05d558c66d7b7dd02327a/f793b/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.556962025316455%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAo0lEQVR42j3OSQ6DMAwFUPYtw66oEkOcmQBhUivU+5/r10RVF09Oonzb2UAagQw25eBaQpkXSXW5l6hq1pbpnrOiKHG753g+aizaY+HcxnVnE58z6hWitPiYgLfyiJ1Mdn5/9RorScxE2ISGNQOsH6G0g7cBgSmh/ohlHYevDQ/+dPCUq/E17eR6cmD1M0Y3IYYIbXxqJnkTKQ2aVqDpiIkfwhfe1FRK9BDbjAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"\"\n        src=\"/static/3d9c4b46dea05d558c66d7b7dd02327a/f058b/img.png\"\n        srcset=\"/static/3d9c4b46dea05d558c66d7b7dd02327a/c26ae/img.png 158w,\n/static/3d9c4b46dea05d558c66d7b7dd02327a/6bdcf/img.png 315w,\n/static/3d9c4b46dea05d558c66d7b7dd02327a/f058b/img.png 630w,\n/static/3d9c4b46dea05d558c66d7b7dd02327a/40601/img.png 945w,\n/static/3d9c4b46dea05d558c66d7b7dd02327a/78612/img.png 1260w,\n/static/3d9c4b46dea05d558c66d7b7dd02327a/f793b/img.png 1404w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>해결방법은 AOP 가 Unwrap 된 객체를 기준으로 명시적인 Reset 을 수행하면 된다.\n이를 위해 AopTestUtils 를 사용하면 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">    <span class=\"token annotation builtin\">@SpykBean</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">lateinit</span> <span class=\"token keyword\">var</span> testClass<span class=\"token operator\">:</span> TestClass\n\n    <span class=\"token annotation builtin\">@BeforeEach</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">clearSpykBean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">clearMocks</span><span class=\"token punctuation\">(</span>AopTestUtils<span class=\"token punctuation\">.</span>getTargetObject<span class=\"token operator\">&lt;</span>TestClass<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>testClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 이슈는 <a href=\"https://github.com/Ninja-Squad/springmockk/issues/85\">@SpykBean not reset / cleared between tests #85</a>에서 확인할 수 있다.\n현재 SpringMockk 프로젝트는 2023년 3월 4.0.2 버전을 마지막으로 업데이트 되고 있지 않다.\n하지만 <a href=\"https://github.com/Ninja-Squad/springmockk/pull/112\">Migration to mock organization #112</a> PR 에서 관리팀이 Ninja-Squad 에서 Mockk 로 이관 중임을 확인할 있다.</p>","frontmatter":{"title":"[Kotlin] Spring Mockk 리셋 이슈","date":"January 10, 2025","description":null}},"previous":{"fields":{"slug":"/documentation/express/TSOA/"},"frontmatter":{"title":"[Node.js] Express.js 서비스에 TSOA 적용하기."}},"next":null},"pageContext":{"id":"c146b920-75e2-5672-8c0a-bc23ba94298a","previousPostId":"b9fad606-92c1-5bdd-a4b1-83ebd84b2733","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}