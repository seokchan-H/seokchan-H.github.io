{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025.02/2025.02.22/","result":{"data":{"site":{"siteMetadata":{"title":"Dudeys Blog"}},"markdownRemark":{"id":"61822c23-7497-563a-bf5b-dd64280e3fdc","excerpt":"Reflection 을 이용한 동적인 호출은 IDE 에서 호출 시점을 추적할 수 없다.\nIDE 가 추적할 수 없는 코드는 리팩토링이 어렵다.\n그렇기에 최대한 추적 가능한 코드를 만들어야한다. 최근 인계받은 프로젝트에서 호출되지 않는 생성자를 여러개 정의한 DTO…","html":"<p>Reflection 을 이용한 동적인 호출은 IDE 에서 호출 시점을 추적할 수 없다.\nIDE 가 추적할 수 없는 코드는 리팩토링이 어렵다.\n그렇기에 최대한 추적 가능한 코드를 만들어야한다.</p>\n<p>최근 인계받은 프로젝트에서 호출되지 않는 생성자를 여러개 정의한 DTO 들을 발견했다.\n사용하지 않는 코드들은 정리하는 것이 좋기에 이를 제거했더니, 바로 빌드가 실패했다.\nIDE 에서도 사용하지 않는다고 경고를 띄우는 코드였는데, 왜 빌드가 실패했을까?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/05487141dab593296eb4669c14682ae6/b7756/img_4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.18987341772152%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApklEQVR42n2OywqCUBiEe6CgRTcTy4jaRZseJI0KitLjOWoXooJe01bqwo1fx1ZB0Gxm5od/+GpolWVZGUVRcLne2B8EIog4+BLPVwQyZrvzcNw17nLDwlkRRmfSNOX7v1Lt+5DlOdPZnG7PZjCcYFqjT7bsMR2jT7Ntah9Qb7QwTJskef0frAjvj+eHLFAxMjwiZITUuSJWuqvohCcUYawJs+xn8A37OLSfRD2W/wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_4.png\"\n        title=\"\"\n        src=\"/static/05487141dab593296eb4669c14682ae6/f058b/img_4.png\"\n        srcset=\"/static/05487141dab593296eb4669c14682ae6/c26ae/img_4.png 158w,\n/static/05487141dab593296eb4669c14682ae6/6bdcf/img_4.png 315w,\n/static/05487141dab593296eb4669c14682ae6/f058b/img_4.png 630w,\n/static/05487141dab593296eb4669c14682ae6/40601/img_4.png 945w,\n/static/05487141dab593296eb4669c14682ae6/78612/img_4.png 1260w,\n/static/05487141dab593296eb4669c14682ae6/b7756/img_4.png 2294w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>이유는 Reflection 을 사용하여 동적으로 생성자를 호출하는 코드가 있었기 때문이었다.\nReflection 을 사용하여 동적으로 생성자를 호출하는 코드는 정적인 코드를 검증하는 IDE 가 추적할 수 없다.</p>\n<p>문제가 되는 코드를 확인해보니 Kotlin JDSL 를 사용하여 selectNew 로 동적인 DTO 매핑에 사용하고 있었다.\nKotlin JDSL 의 selectNew 는 Hibernate 의 DomainResult 중 DynamicInstantiationResult 로 지원된다.</p>\n<p>DomainResult 는 DomainResultAssembler 를 사용하여 ResultSet 을 DTO 로 매핑한다.\nDomainResult 는 createResultAssembler 로 자신의 상태에 맞는 DomainResultAssembler 를 생성한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c315860b7d38fed92fac26a21e3ab7ba/599ea/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.0379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtUlEQVR42lWQ6XLaQBCE9SSpJGADJhjdt/YWBRI6DMhx3v9BOqOVXan8+Gpndnta03KiMEAYeJZ4rn0Pge8iCnxEoQ/3eEAaR9BKwCgJLQWU5DBa2jvJK9vnWWK1znhKcTvFeFxyjHWMhh8xmNDWo4nQChcm24GHa/Bg9Y/PvnS/g3k/oJIddLqFM/Q3jH2Pt3HE0HX0RU6IBcZpIwUlJARj4GUJUZXgRY6KNqqy1MKKgrbVdsYZbn8wDA9iwu3+gWGccO1u6Ps7lD6jrluigTYXmLk+XYnWog3dk4bzGudLb7XO1HKKm2FqS3x0zEZ/NDlOxd5G0OkOKt4sdbL0X3eSqNxvEOEKOt9TbIo8dQaP2bQVaCT9/OwVpjhCZr+g8lcSLr3Oj1DpATLZowqeiLWl9FYQ8Q516Vmtc28lfncSfZ1CkUldupDp3tYqO1iRTF7sEAsXIzab+StL6f2kty3qwrV6Z7pqvLcM753AQKadTmByMiJDe37WkoZEtCGe7TmbstmUDOe3eRE9G46NxNuFYTwvXE1OUY8QyQEi/R8WvaAKNyiDDQpvbcldMg23kPNMesBfZn4yz4x1Xk4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"\"\n        src=\"/static/c315860b7d38fed92fac26a21e3ab7ba/f058b/img.png\"\n        srcset=\"/static/c315860b7d38fed92fac26a21e3ab7ba/c26ae/img.png 158w,\n/static/c315860b7d38fed92fac26a21e3ab7ba/6bdcf/img.png 315w,\n/static/c315860b7d38fed92fac26a21e3ab7ba/f058b/img.png 630w,\n/static/c315860b7d38fed92fac26a21e3ab7ba/40601/img.png 945w,\n/static/c315860b7d38fed92fac26a21e3ab7ba/78612/img.png 1260w,\n/static/c315860b7d38fed92fac26a21e3ab7ba/599ea/img.png 1926w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>이때 DynamicInstantiationResult 는 Reflection 을 사용하여 지정된 TargetClass 의 모든 생성자를 불러온다.\n그 중 Argument 의 순서와 항목이 일치하는 것이 존재할 때 DynamicInstantiationAssemblerConstructorImpl 를 선택하게 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1b8211f8477d30ca0cab932ed38c07ca/19ab6/img_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.734177215189874%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaklEQVR42o1SWXaDMBDjHk0CGDDGK2EJS5be/1TqjBPSLX2vHwIPHgtJ48RZj3laMJwuGMYVy/kd40zrjr61M07zFdN6w0yYlmvc55rhwwAXetTKIS9qiFIhybICTlu0oYNvexjXwrkj+nCCsQHtcUD7+N4YD1FIpHQmy0scUoHdPovvDQlvMpxSsKTWEvGxG4loRGgH9MMU60CkjKJSpEY+CX8i4Y39QSBojanrcJ4XLGRtOs1Y1wvW8y0q9WTNWFKpHVm0KMqazuV/EzayxkhqPCksqVlTLSsJWWuUVQOpDN52abTIeEV2t8zSyXIhSmjKSJtwV9FYgiMl6knA0bwi+ZUhq2TkDFHFjDh8tsU1N/6HLBLyg4PmKSpSxCo5K1U3EKR6t8+jupdIv9dPhVVVwxsLvpM8WZ4mW9c0DB4IR8Dgn21rKTVM5VFLE3ssCeJhJYIuZJp+2tmsbVFwxtvV+oqtZ0P26PsA18ciwsAy5eMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_2.png\"\n        title=\"\"\n        src=\"/static/1b8211f8477d30ca0cab932ed38c07ca/f058b/img_2.png\"\n        srcset=\"/static/1b8211f8477d30ca0cab932ed38c07ca/c26ae/img_2.png 158w,\n/static/1b8211f8477d30ca0cab932ed38c07ca/6bdcf/img_2.png 315w,\n/static/1b8211f8477d30ca0cab932ed38c07ca/f058b/img_2.png 630w,\n/static/1b8211f8477d30ca0cab932ed38c07ca/40601/img_2.png 945w,\n/static/1b8211f8477d30ca0cab932ed38c07ca/78612/img_2.png 1260w,\n/static/1b8211f8477d30ca0cab932ed38c07ca/19ab6/img_2.png 1664w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>여기서 Argument 는 kdsl 의 selectNew 에서 정의한 Query 의 Column 순서이다.\n이 Query 가 hibernate 의 hq 로 변경된 후 조회되며, 그 결과가 ArgumentReader 에 의해 정의된 순서대로 매핑된다.</p>\n</blockquote>\n<p>다른 Assembler 도 존재하지만 selectNew 는 기본 구현상으로는 DynamicInstantiationAssemblerConstructorImpl 로 매칭된다.</p>\n<p>그런데 내가 매칭되는 생성자를 지워버렸으니, 테스트 중에 에러가 발생했던 것이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/daa636f0456078be07333c434ced112e/18d85/img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.202531645569614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABdUlEQVR42pWSzSvDARjH93e4uclJWUxs/DStxbCZFRbNy1DL60FmXtb6eQ1TysGcvOWovMQBFzlI7SCSk5KIbGgL7beP+dlFtvAcnufwfPv0/T49ChJUNPoWa++EQkH8F0fcP14TDgd4CN7IO0l6JVkpfsI+ewwWfsTla8EwmEmdWEzjeDlmTx7HZ3uyTopKfwXKRJZ2ZjG4lVS41ZQ5c6joFagcEKgdKuHk9PCbNilQkiLyPDjZxuhRYRHVdHltWFvNOMVuVjYW0Jk1rK0vJnX5DRiJA+c2Ryn1KLF6i6j26ijr02AczMMynE/DhJH7wPX/HPp2JzGIWdg8hTg6c6l3qrGKAjUjAlWx+H7/flwv/Q04vzWMaSyNZlcu3fZs+ppUuGxK2i3pjNv13F6dxx3+FjnyJXBMn5Fi6kTbU4y2vxB9fz5CRwkzqzO8hm7lL0gUN8ENv6Z7GVJrIcfxhKbtkoL2UzLsAVqnXnh5vosp3kjC4wMobGSG81qVoAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_1.png\"\n        title=\"\"\n        src=\"/static/daa636f0456078be07333c434ced112e/f058b/img_1.png\"\n        srcset=\"/static/daa636f0456078be07333c434ced112e/c26ae/img_1.png 158w,\n/static/daa636f0456078be07333c434ced112e/6bdcf/img_1.png 315w,\n/static/daa636f0456078be07333c434ced112e/f058b/img_1.png 630w,\n/static/daa636f0456078be07333c434ced112e/40601/img_1.png 945w,\n/static/daa636f0456078be07333c434ced112e/78612/img_1.png 1260w,\n/static/daa636f0456078be07333c434ced112e/18d85/img_1.png 2382w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>자, 여기까지 이해했다면 내가 원인을 파악하기 위해 프레임워크를 디버깅하는 아주 비생산적인 행위를 했단 것을 알 수 있다.\n이런 일이 없길 바란다면 API 사용자는 최대한 추적가능한 코드를 만들어야 한다.</p>\n<p>만약 나라면 생성자를 다양화하는 것이 아니라 클래스를 다양화를 선택했을 것 같다.\n생성자의 호출부가 없어도 클래스 타입을 지정한 위치를 통해 사용사례를 파악할 수 있지 않을까?</p>","frontmatter":{"title":"[Kotlin] Kotlin JDSL 삽질 일기","date":"February 22, 2025","description":null}},"previous":{"fields":{"slug":"/trouble-shooting/spring-mockk/spykbean-not-reset/"},"frontmatter":{"title":"[Kotlin] Spring Mockk 리셋 이슈"}},"next":{"fields":{"slug":"/2025.03/2025.03.23/"},"frontmatter":{"title":""}}},"pageContext":{"id":"61822c23-7497-563a-bf5b-dd64280e3fdc","previousPostId":"c146b920-75e2-5672-8c0a-bc23ba94298a","nextPostId":"22206995-5f01-52fc-98ed-91ccbece3967"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}